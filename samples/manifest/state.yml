# State class テスト用 - _store/_load の各パターンを網羅
# _state.type は map の場合省略(子要素で自明)

# 1. Env → InMemory パターン
config:
  _store:
    client: InMemory # InMemory/Env/KVS/DB/API
    key: "app_config"
  _load:
    client: Env
    map:
      api_url: "API_URL"
      timeout: "API_TIMEOUT"

  api_url:
    _state:
      type: string # interger|float|string|boolean|null|list|map
  timeout:
    _state:
      type: integer

# 2. DB → KVS パターン (キャッシュ)
user:
  _store:
    client: KVS
    key: "user:${user_id}"
    ttl: 3600
  _load:
    client: DB
    connection: common
    table: users
    where: "id=${user_id}"
    map:
      id: "id"
      name: "name"
      email: "email"

  id:
    _state:
      type: integer
  name:
    _state:
      type: string
  email:
    _state:
      type: string

# 3. KVS のみ (load無し - set専用)
session:
  _store:
    client: KVS
    key: "session:${session_id}"
    ttl: 1800

  token:
    _state:
      type: string
  expires_at:
    _state:
      type: integer

# 4. API → InMemory パターン
external_data:
  _store:
    client: InMemory
    key: "external:${id}"
  _load:
    client: API
    url: "https://api.example.com/data/${id}"
    method: GET
    map:
      title: "title"
      content: "content"

  title:
    _state:
      type: string
  content:
    _state:
      type: string

# 5. スカラー値のテスト (mapでない)
counter:
  _state:
    type: integer
  _store:
    client: InMemory
    key: "counter"
  _load:
    client: Env
    env_key: "INITIAL_COUNTER"

flag:
  _state:
    type: boolean
  _store:
    client: InMemory
    key: "feature_flag"

# 6. list型のテスト
tags:
  _state:
    type: list
  _store:
    client: KVS
    key: "tags:${resource_id}"
    ttl: 7200
  _load:
    client: DB
    connection: common
    table: tags
    where: "resource_id=${resource_id}"
    map:
      list: "tag_name"