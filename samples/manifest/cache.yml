app: # KVStore app scopeの定義ブロック

  _keyPrefix: "app:"
  _ttl: null
  _store:
    client: KVS
    key: "app:${key}"

  org_tenant_map:
    _key: "org_tenant_map"
    _state:
      type: map
      keys:
        type: integer
      values:
        type: integer
    _store:
      client: KVS
      key: "app:org_tenant_map"
    _load:
      client: DB
      connection: common
      table: "tenants"
      map:
        key: "sso_org_id" # org_id
        value: "id" # tenant_id

user: # KVStore user scopeの定義ブロック

  _key: "user:${sso_user_id}"
  _ttl: 14400 # (second) = 4 (hour)
  _state:
    type: map
  _store:
    client: KVS
    key: "user:${sso_user_id}"
  _load:
    client: DB
    connection: tenant
    table: "users"
    where: "sso_user_id=${sso_user_id}"
    map:
      id: "id"
      org_id: "sso_org_id"

  id:
    _state:
      type: integer
  org_id:
    _state:
      type: integer
  tenant_id:
    _state:
      type: integer
    _load:
      client: EXPRESSION
      expression: "scope('app')->get('org_tenant_map')[${org_id}]"

tenant: # KVStore tenant scopeの定義ブロック

  _key: "tenant:${tenant_id}"
  _ttl: null
  _state:
    type: map
  _store:
    client: KVS
    key: "tenant:${tenant_id}"
  _load:
    client: DB
    connection: common
    table: "tenants"
    where: "id=${tenant_id}"
    map:
      name: "name"
  name:
    _state:
      type: string
