# cache.yml - KVS state management sample

user:
  _state:
    type: map
  _store:
    client: KVS
    key: "user:${sso_user_id}"
    ttl: 14400  # 4 hours in seconds
  _load:
    client: DB
    connection: tenant
    table: "users"
    where: "sso_user_id='${sso_user_id}'"
    map:
      id: "id"
      org_id: "sso_org_id"

  id:
    _state:
      type: integer
  org_id:
    _state:
      type: integer
  tenant_id:
    _state:
      type: integer
    # tenant_idは別のstateから取得する例
    # 実装はapp側のEXPRESSION client次第
    _load:
      client: EXPRESSION
      expression: "get_tenant_id_from_org(${org_id})"

tenant:
  _state:
    type: map
  _store:
    client: KVS
    key: "tenant:${tenant_id}"
    ttl: 3600  # 1 hour
  _load:
    client: DB
    connection: common
    table: "tenants"
    where: "id=${tenant_id}"
    map:
      name: "name"
      display_name: "display_name"

  name:
    _state:
      type: string
  display_name:
    _state:
      type: string

# session - set専用の例（_loadなし）
session:
  _state:
    type: map
  _store:
    client: KVS
    key: "session:${session_id}"
    ttl: 1800  # 30 minutes

  token:
    _state:
      type: string
  user_id:
    _state:
      type: integer
  expires_at:
    _state:
      type: integer
