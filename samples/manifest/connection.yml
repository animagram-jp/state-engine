common:
  _state:
    type: map
  _store:
    client: InMemory  # プロセススコープでキャッシュ（K8s Pod 内で再利用）
    key: 'connection.common'
  _load:
    client: Env
    map:
      host: 'DB_HOST'
      port: 'DB_PORT'
      database: 'DB_DATABASE'
      username: 'DB_USERNAME'
      password: 'DB_PASSWORD'

  # 完全な接続設定（Manifest static values）
  # samples/app/.env の PostgreSQL 環境に合わせた設定
  driver: 'postgres'
  charset: 'UTF8'

  host:
    _state:
      type: string
  port:
    _state:
      type: integer
  database:
    _state:
      type: string
  username:
    _state:
      type: string
  password:
    _state:
      type: string

tenant:
  _state:
    type: map
  _store:
    client: InMemory  # テナント毎の接続をプロセススコープでキャッシュ
    key: 'connection.tenant${cache.user.tenant_id}'
  _load:
    client: DB
    connection: ${connection.common}  # 共通接続を使ってテナント情報を取得
    table: 'tenants'
    where: 'id=${cache.user.tenant_id}'
    map:
      host: 'db_host'
      port: 'db_port'
      database: 'db_database'
      username: 'db_username'
      password: 'db_password'

  # 完全な接続設定（Manifest static values）
  driver: 'postgres'
  charset: 'UTF8'

  host:
    _state:
      type: string
  port:
    _state:
      type: integer
  database:
    _state:
      type: string
  username:
    _state:
      type: string
  password:
    _state:
      type: string
